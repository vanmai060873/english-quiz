<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>English Quiz Pro</title>

<style>
body{
    font-family:Arial;
    margin:0;
    display:flex;
    height:100vh;
}

#sidebar{
    width:20%;
    background:#f0f0f0;
    padding:10px;
    overflow-y:auto;
    border-right:1px solid #ccc;
}

#sidebar button{
    width:45px;
    height:45px;
    margin:5px;
    border:none;
    cursor:pointer;
    background:#ddd;
    font-weight:bold;
}

.done{
    background:green !important;
    color:white;
}

#content{
    width:80%;
    padding:20px;
    overflow-y:auto;
}

.question{
    background:#fff;
    padding:15px;
    margin-bottom:15px;
    border-radius:8px;
    border:1px solid #ddd;
}

.correct{ color:green; font-weight:bold }
.wrong{ color:red; font-weight:bold }

button.action{
    padding:10px 20px;
    margin:10px 5px;
    font-size:16px;
}

#timer{
    font-size:20px;
    font-weight:bold;
    color:red;
    margin-bottom:10px;
}
</style>
</head>

<body>

<div id="sidebar"></div>

<div id="content">
    <h2>English Random Quiz</h2>
    <div id="timer">Time: 45:00</div>
    <div id="quiz"></div>

    <button class="action" onclick="finishQuiz()">KẾT THÚC</button>
    <button class="action" onclick="loadNew()">TIẾP TỤC (50 câu khác)</button>

    <div id="result"></div>
</div>

<script>

let allQuestions=[];
let currentQuestions=[];
let timeLeft=45*60;
let timerInterval;
let totalQuestions=60;

fetch("questions.txt")
.then(r=>r.text())
.then(text=>{
    parse(text);
    loadQuiz(60);
});

function parse(text){
    let blocks=text.split(/\n\s*\n/);
    blocks.forEach(block=>{
        let lines=block.trim().split("\n");
        if(lines.length>=6){
            allQuestions.push({
                question:lines[0],
                options:lines.slice(1,5),
                answer:lines[5].replace("ANSWER:","").trim()
            });
        }
    });
}

function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
        let j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
}

function loadQuiz(number){

    totalQuestions=number;

    clearInterval(timerInterval);
    timeLeft=45*60;
    startTimer();

    document.getElementById("quiz").innerHTML="";
    document.getElementById("sidebar").innerHTML="";
    document.getElementById("result").innerHTML="";

    let randomSet=shuffle([...allQuestions]).slice(0,number);
    currentQuestions=randomSet;

    randomSet.forEach((q,index)=>{

        let navBtn=document.createElement("button");
        navBtn.innerText=index+1;
        navBtn.id="nav"+index;
        navBtn.onclick=function(){
            document.getElementById("q"+index)
                .scrollIntoView({behavior:"smooth"});
        };
        document.getElementById("sidebar").appendChild(navBtn);

        let div=document.createElement("div");
        div.className="question";
        div.id="q"+index;

        let options=shuffle([...q.options]);

        let html=`<p><b>${index+1}. ${q.question}</b></p>`;

        options.forEach(opt=>{
            let letter=opt.charAt(0);
            html+=`
            <label>
            <input type="radio"
                   name="q${index}"
                   value="${letter}"
                   onchange="markDone(${index})">
            ${opt}
            </label><br>`;
        });

        div.innerHTML=html;
        document.getElementById("quiz").appendChild(div);
    });
}

function markDone(index){
    document.getElementById("nav"+index)
        .classList.add("done");
}

function startTimer(){
    timerInterval=setInterval(()=>{
        let minutes=Math.floor(timeLeft/60);
        let seconds=timeLeft%60;
        seconds=seconds<10?"0"+seconds:seconds;

        document.getElementById("timer")
            .innerText=`Time: ${minutes}:${seconds}`;

        timeLeft--;

        if(timeLeft<0){
            clearInterval(timerInterval);
            alert("Hết giờ! Bài sẽ được nộp tự động.");
            finishQuiz();
        }
    },1000);
}

function finishQuiz(){

    clearInterval(timerInterval);

    let correctCount=0;
    let answeredCount=0;

    currentQuestions.forEach((q,index)=>{
        let correct=q.answer;
        let selected=document.querySelector(`input[name="q${index}"]:checked`);
        let div=document.getElementById("q"+index);

        div.querySelectorAll("label").forEach(lb=>{
            if(lb.innerText.trim().startsWith(correct)){
                lb.classList.add("correct");
            }
        });

        if(selected){
            answeredCount++;
            if(selected.value===correct){
                correctCount++;
            }else{
                selected.parentElement.classList.add("wrong");
            }
        }
    });

    let unanswered = totalQuestions - answeredCount;

    let pointPerQuestion = 10 / totalQuestions;
    let finalScore = (correctCount * pointPerQuestion).toFixed(2);

    document.getElementById("result").innerHTML=
        `<h3>
        Số câu đúng: ${correctCount}<br>
        Số câu đã làm: ${answeredCount}<br>
        Số câu chưa làm: ${unanswered}<br>
        Điểm: ${finalScore} / 10
        </h3>`;
}

function loadNew(){
    loadQuiz(50);
}

</script>

</body>
</html>
