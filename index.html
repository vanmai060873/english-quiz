<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>English Quiz Pro</title>

<style>
body{
    font-family:Arial;
    margin:0;
    display:flex;
    height:100vh;
}

#sidebar{
    width:20%;
    background:#f0f0f0;
    padding:10px;
    overflow-y:auto;
    border-right:1px solid #ccc;
}

#sidebar button{
    width:45px;
    height:45px;
    margin:5px;
    border:none;
    cursor:pointer;
    background:#ddd;
    font-weight:bold;
}

.done{
    background:green !important;
    color:white;
}

#content{
    width:80%;
    padding:20px;
    overflow-y:auto;
}

.question{
    padding:15px;
    margin-bottom:15px;
    border-radius:8px;
    border:1px solid #ddd;
}

.even{ background:#e6f4ea; }
.odd{ background:#ffe8cc; }

.question-title{
    font-weight:bold;
    color:#800000;
}

.correct{ color:green; font-weight:bold }
.wrong{ color:red; font-weight:bold }

button.action{
    padding:10px 20px;
    margin:10px 5px;
    font-size:16px;
}

#timer{
    font-size:20px;
    font-weight:bold;
    color:red;
    margin-bottom:10px;
}

/* POPUP */
#popup{
    display:none;
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.5);
    justify-content:center;
    align-items:center;
}

#popupContent{
    background:white;
    padding:30px;
    border-radius:10px;
    text-align:center;
    width:380px;
}
</style>
</head>

<body>

<div id="sidebar"></div>

<div id="content">

    <h2>English Random Quiz</h2>

    <div id="nameSection">
        <label>Nhập tên của bạn: </label>
        <input type="text" id="studentName">
        <button onclick="startQuiz()">BẮT ĐẦU</button>
    </div>

    <div id="quizSection" style="display:none;">
        <div id="timer">Time: 45:00</div>
        <div id="quiz"></div>
        <button class="action" onclick="finishQuiz()">KẾT THÚC</button>
    </div>

</div>

<div id="popup">
    <div id="popupContent">
        <h3 id="popupResult"></h3>
        <br>
        <button onclick="retakeQuiz()">THI LẠI</button>
        <button onclick="closeProgram()">ĐÓNG</button>
    </div>
</div>

<script>

let allQuestions=[];
let currentQuestions=[];
let timeLeft=45*60;
let timerInterval;
let totalQuestions=60;
let submitted=false;
let studentName="";

fetch("questions.txt")
.then(r=>r.text())
.then(text=>parse(text));

function parse(text){
    let blocks=text.split(/\n\s*\n/);
    blocks.forEach(block=>{
        let lines=block.trim().split("\n");
        if(lines.length>=6){
            allQuestions.push({
                question:lines[0],
                options:lines.slice(1,5),
                answer:lines[5].replace("ANSWER:","").trim()
            });
        }
    });
}

function startQuiz(){
    let nameInput=document.getElementById("studentName").value.trim();
    if(nameInput===""){
        alert("Vui lòng nhập tên!");
        return;
    }

    studentName=nameInput;
    document.getElementById("nameSection").style.display="none";
    document.getElementById("quizSection").style.display="block";

    loadQuiz(60);
}

function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
        let j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
}

function loadQuiz(number){

    submitted=false;
    totalQuestions=number;

    clearInterval(timerInterval);
    timeLeft=45*60;
    startTimer();

    document.getElementById("quiz").innerHTML="";
    document.getElementById("sidebar").innerHTML="";

    let randomSet=shuffle([...allQuestions]).slice(0,number);
    currentQuestions=randomSet;

    randomSet.forEach((q,index)=>{

        let navBtn=document.createElement("button");
        navBtn.innerText=index+1;
        navBtn.id="nav"+index;
        navBtn.onclick=function(){
            document.getElementById("q"+index)
                .scrollIntoView({behavior:"smooth"});
        };
        document.getElementById("sidebar").appendChild(navBtn);

        let div=document.createElement("div");
        div.className="question " + (index%2===0 ? "even":"odd");
        div.id="q"+index;

        let options=shuffle([...q.options]);

        let html=`<p class="question-title">${index+1}. ${q.question}</p>`;

        options.forEach(opt=>{
            let letter=opt.charAt(0);
            html+=`
            <label>
            <input type="radio"
                   name="q${index}"
                   value="${letter}"
                   onchange="markDone(${index})">
            ${opt}
            </label><br>`;
        });

        div.innerHTML=html;
        document.getElementById("quiz").appendChild(div);
    });
}

function markDone(index){
    if(!submitted){
        document.getElementById("nav"+index).classList.add("done");
    }
}

function startTimer(){
    timerInterval=setInterval(()=>{
        let minutes=Math.floor(timeLeft/60);
        let seconds=timeLeft%60;
        seconds=seconds<10?"0"+seconds:seconds;
        document.getElementById("timer").innerText=`Time: ${minutes}:${seconds}`;
        timeLeft--;

        if(timeLeft<0){
            clearInterval(timerInterval);
            finishQuiz();
        }
    },1000);
}

function finishQuiz(){

    if(submitted) return;
    submitted=true;
    clearInterval(timerInterval);

    let correctCount=0;

    currentQuestions.forEach((q,index)=>{
        let correct=q.answer;
        let selected=document.querySelector(`input[name="q${index}"]:checked`);
        let div=document.getElementById("q"+index);

        div.querySelectorAll("label").forEach(lb=>{
            if(lb.innerText.trim().startsWith(correct)){
                lb.classList.add("correct");
            }
        });

        if(selected){
            if(selected.value===correct){
                correctCount++;
            }else{
                selected.parentElement.classList.add("wrong");
            }
        }
    });

    document.querySelectorAll("input[type=radio]").forEach(r=>{
        r.disabled=true;
    });

    let finalScore=(correctCount*(10/totalQuestions)).toFixed(2);

    document.getElementById("popupResult").innerHTML=
        `Thí sinh: <b>${studentName}</b><br><br>
         Số câu đúng: ${correctCount}<br><br>
         Điểm: ${finalScore} / 10`;

    document.getElementById("popup").style.display="flex";
}

function retakeQuiz(){
    document.getElementById("popup").style.display="none";
    loadQuiz(60);
}

function closeProgram(){
    document.body.innerHTML="<h2 style='text-align:center;margin-top:200px;'>Bài thi đã kết thúc.</h2>";
}

</script>

</body>
</html>
